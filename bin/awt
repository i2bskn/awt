#!/usr/bin/env ruby

path = File.expand_path("../../lib", __FILE__)
$:.unshift(path) unless $:.include?(path)

require "optparse"

require "awt"
require "awt/dsl"

include Awt::DSL

options = {}
OptionParser.new do |opt|
  opt.on("-H VAL") {|v| options[:hosts] = v.split(",")}
  opt.on("-u VAL") {|v| options[:user] = v}
  opt.on("-p VAL") {|v| options[:port] = v.to_i}
  opt.on("-i VAL") {|v| options[:key] = v}
  opt.on("-f VAL") {|v| options[:task_file] = v}

  begin
    opt.parse!(ARGV)
  rescue => e
    puts e
    exit 1
  end
end

task_name = ARGV.first.to_sym
hosts = options.delete(:hosts) || []
task_file = options.delete(:task_file) || task_find

hosts.each do |host|
  server host, options
end

unless task_file.nil?
  load task_file
  $AWT_TASKS[task_name].exec($AWT_TARGETS)
end
